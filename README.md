* Spectral anomaly mapping system

** Requirements
- Matplotlib v. 1.1.1
- Matplotlib Basemap toolkit v. 1.0.5
- Numpy 1.6
- SciPy 0.11
- PostgreSQL 8.4 (9+ preferred)
- PostGIS 1.5+
- Python 2.7
- psycopg 2.4
- eMorpho module
- As many CPU cores as you can find

** Reference systems
Observations are stored in WGS 84 lat/lon coordinates (SRID 4326). Maps and
analysis are done on the NSRS 2007 Texas Central plane (SRID 3663), which
conveniently has coordinates in meters. This is a Lambert conformal conic
projection, so maps are always in that projection.

** Installation
*** Generate UI
The UI files in the =ui= directory are generated by Qt Designer. To work with
PyQt, they're turned into Python classes with the =pyuic4= utility.

Execute within 'ui' directory:
pyuic4 analyze.ui -o ui_analyzewindow.py
pyuic4 monitor.ui -o ui_monitorwindow.py

This is necessary after every change you make to the UI files.

*** Set up Postgres
Note that the scripts expect a user named "radiation" with the password
"radiation"; I felt very creative.

**** Create user
     sudo -u postgres createuser radiation

**** Create database "radiation
sudo -u postgres createdb -O radiation radiation

**** Change password to "radiation"
sudo -u postgres                                                        
psql
psql (9.1.8)
Type "help" for help.

postgres=# \password radiation
Enter new password:
Enter it again:
postgres=# \q

**** Log in as user "radiation"
psql --host=localhost --user=radiation -W

**** Install PostGIS
cd /usr/share/postgresql/9.1/contrib/postgis-1.5
sudo -u postgres createlang plpgsql radiation
sudo -u postgres psql -f postgis.sql -d radiation
sudo -u postgres psql -f spatial_ref_sys.sql -d radiation
sudo -u postgres psql -f postgis_comments.sql -d radiation

*** Import data
Postgres can import backup files from the command line console using the \i
command. Obtain a recent histograms.backup file and type these commands in the
directory containing it:

psql --user=radiation --host=localhost -W
radiation=> \i histograms.backup

*** Generate correlation matrices
python correlate.py

See the Tour section for details.

*** Install eMorpho code
The emorpho_cpython module is on GitHub:
https://github.com/capnrefsmmat/emorpho-cpython

There is a linux branch in Git which contains the Linux version of the eMorpho
API. To install:

- install libftdi-dev and libusb-dev packages
- cd to emorpho_cpython directory
- python setup.py build
- sudo python setup.py install

** Tour
Each Python module should be reasonably well-documented with docstrings. Check
them for details.

- thesis/ contains the LaTeX source and PDF for my undergraduate thesis,
  which covers the algorithms and results behind all this code.
- maps/ contains a set of ESRI shapefiles for various locations. Each
  shapefile is contained in a directory with the same name. If you need to edit
  a shapefile, I find that Quantum GIS works reasonably well. You can get
  handy maps by using OpenStreetMap, which has free-to-use map data; check
  http://wiki.openstreetmap.org/wiki/Shapefiles for instructions.
- plots/ contains Python modules for creating various plots using Matplotlib.
  - =bihist= takes two CSV files containing, say, D^2 statistics and makes a
    bihistogram of them both, with optional legend.
  - =maps= makes various count rate and anomaly maps.
  - =spectra= smooths and plots spectra.
  - =tempPlot= plots the detector temperature over a given time range.
- pyqtgraph is used for the analysis and monitoring scripts to plot data live.
- samples/ contains a number of spectra recorded with the scintillator in the
  form of CSVs. These are used for simulations.
- sim/ contains several simulation scripts, including the main =simulate=. This
  will insert a source at some GPS location and simulate the data that would be
  collected if you had taken a given route.
- test/ contains automated tests using the =unittest= module. You can run all
  tests with =run-test.sh=. I highly recommend adding automated tests for all
  new analyses.
- ui/ contains the Qt UI files as well as the PyQT adapter bits.
- util/ contains a number of useful modules, such as the UTC and CST
  timezone specifications, the =gps= module, and the =battery= monitor module.
- web/ holds the static resources for the web monitor module.

There are a number of root-level modules:
- =analyze= is a Qt interface to let you select data and see it plotted live,
  along with average count rates, spectra and so on.
- =batch= runs analysis functions over the entire dataset, using
  =multiprocessing= for parallelism. Add additional analysis functions if you
  need to trawl the data.
- =monitor= is a Qt interface to watch scintillator data live, and optionally
  record it in Postgres or save the spectrum to a CSV. It contains some
  Windows-specific sound code (to beep when cables are disconnected) which will
  have to be removed on Linux.
- =correlate= creates the correlation matrices needed by SCRAM and saves them
  to disk in =correlation.mat=. If you switch to analyzing a new dataset,
  adjust `correlate` to analyze it and run it before using SCRAM.
- =headlessMonitor= records data without a Qt interface, using Linux-specific
  code to access =gpsd='s location interface. Records until killed.
- =krige= and =nscrad= are the analysis modules for Poisson kriging and SCRAM.
- =webmonitor= fires up a CherryPy server and makes data available through a
  web interface. Set up an ad-hoc wifi network and disable the Windows
  firewall to make this available to other devices. =webmonitor= must be
  started *after* the ad-hoc network is set up so it will listen on the correct
  IP address.

** Collecting data
To record data, follow these steps:

- Log in to the REINHART-LAPTOP\datacollect account on the laptop.
- Plug in the GPS and scintillator via USB. The data collector script will not
  load without the scintillator plugged in, though it's fine without the GPS.
- Fire up =monitor.py= using the "Data collection" desktop shortcut. This will
  create a command line window and the graphical data collection interface;
  serious errors will appear in the command line window.
- The scintillator should be detected automatically; you will see a
  notification in the status bar saying the eMorpho has been detected and is
  warming up.
- You will need to specify the serial port which the GPS is plugged into. On
  the laptop this is usually COM8 or COM9; if you pick the wrong port, a
  "Failed to connect to GPS" message will appear in the command line window.
- Once everything is connected, you can check the "Collect data" box to start
  acquiring data from the scintillator. The last 30 samples will be aggregated
  and shown in the histogram display, and the most recent count rates will be
  graphed. The histogram display is uncalibrated.
- Check the "Record data" box to have the acquired data saved into Postgres.
- Check the "Power save" box to disable the updating of the graphs, which might
  save some CPU power. Probably not very much. Use is optional.
- Click the "Save spectrum" button if you want to record the currently
  displayed spectrum as a CSV file. You can also clear the displayed spectrum
  and start fresh.

If you need to collect data with the laptop closed, there is a Windows power
mode set up to allow this to work. Find the power options in the status bar and
select the "Data collection" mode; you might need to hit "More power options"
to find it. This prevents the laptop from sleeping when the lid is closed.

If the laptop speakers are unmuted, the script will emit beeps if cables become
unplugged and data is not collected. If the GPS fix is lost, the script will
beep but data will still be collected, with the GPS HDOP recorded as -1 to note
that the position was unknown. (The sound code is Windows-specific and would
have to be removed on a Linux or Mac setup.)

** Data
I drove through PRC almost every business day between June 22nd and August 8th,
2012. I started simply driving to NETL and back, and gradually expanded my
route to include most of campus.

On September 14th, 2012, industrial radiography was performed at the new
chilling station behind TACC. Todd Hay collected data in the morning by driving
behind the chilling station, recording a massive anomaly. I had collected
background data on the 13th.

I also recorded data on main campus during the semester to build a baseline
map, taking long walks on the following days:
- September 25th in the evening. Faulty timezone data means it extends into the
  morning of the 26th.
- September 30th.
- October 13th.

*** Stadium data
We collected stadium background data with the stadium empty on the following
days:
- September 26th. Time zone data is faulty; data appears to be in the afternoon,
  but it was collected in the morning.
- October 1st. Similar time zone issues.
- October 3rd. Same issues.

We collected game data on the following days:
- October 6th, 2012, late at night. The time zone data is wonky here, so the
  data extends into October 7th. We had trouble with GPS and cable connections,
  so not all of the stadium is covered. Prior to the game we stood at the
  southwest entry gate and recorded people walking through. GPS wandered
  quite a bit there, so it appears as a giant mess on the map. We recorded two
  anomalies: one while standing at the gate, and one in the east lower deck
  (section 29). The second was confirmed with radiation pagers, and appeared
  to be iodine-131 in spectra.
- October 20th, late at night. We successfully mapped the entire stadium by
  using rubber bands to ensure plugs didn't fall out. We detected a source in 
  the northwest lower deck (section 13), verified as Tc-99m. Poor GPS reception
  smeared this source across the field and into the east lower deck. Subsequent
  re-analysis detected a small Tc-99m source in the west lower deck (near
  section 5).
- November 10th. There was again more GPS trouble, but we successfully detected
  a Tc-99m source in the northeast upper deck. Before the game, EHS alerted us
  to a source on the southwest corner of the field, which we detected (at more
  than 10,000 cps up close!).

I sent after-action reports to Alex Athey, Scott Pennington and Steve Biegalski
after each game; consult these for more detail on events.

*** Quirks
Some things to be aware of in the dataset:
- On the morning of July 12, 2012, I held the detector up to the PETEX building
  wall, recording a large count rate and spectral anomaly. This appears
  regularly in batch analyses of the data as one of the largest anomalies.
- On August 7, 2012, we recorded data inside the NETL conference room with
  several known sources nearby, causing another anomaly.
- Time zone data was not reliable before about October 10th. Some has been
  corrected, but not all.
